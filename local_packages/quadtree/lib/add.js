"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = _default;
exports.addAll = addAll;

function _default(d) {
  var x = +this._x.call(null, d),
      y = +this._y.call(null, d);
  return add(this.cover(x, y), x, y, d);
}

function add(tree, x, y, d) {
  if (isNaN(x) || isNaN(y)) return tree;
  var parent,
      node = tree._root,
      leaf = {
    data: d
  },
      x0 = tree._x0,
      y0 = tree._y0,
      x1 = tree._x1,
      y1 = tree._y1,
      xm,
      ym,
      xp,
      yp,
      right,
      bottom,
      i,
      j;
  if (!node) return tree._root = leaf, tree;

  while (node.length) {
    if (right = x >= (xm = (x0 + x1) / 2)) x0 = xm;else x1 = xm;
    if (bottom = y >= (ym = (y0 + y1) / 2)) y0 = ym;else y1 = ym;
    if (parent = node, !(node = node[i = bottom << 1 | right])) return parent[i] = leaf, tree;
  }

  xp = +tree._x.call(null, node.data);
  yp = +tree._y.call(null, node.data);
  if (x === xp && y === yp) return leaf.next = node, parent ? parent[i] = leaf : tree._root = leaf, tree;

  do {
    parent = parent ? parent[i] = new Array(4) : tree._root = new Array(4);
    if (right = x >= (xm = (x0 + x1) / 2)) x0 = xm;else x1 = xm;
    if (bottom = y >= (ym = (y0 + y1) / 2)) y0 = ym;else y1 = ym;
  } while ((i = bottom << 1 | right) === (j = (yp >= ym) << 1 | xp >= xm));

  return parent[j] = node, parent[i] = leaf, tree;
}

function addAll(data) {
  var d,
      i,
      n = data.length,
      x,
      y,
      xz = new Array(n),
      yz = new Array(n),
      x0 = Infinity,
      y0 = Infinity,
      x1 = -Infinity,
      y1 = -Infinity;

  for (i = 0; i < n; ++i) {
    if (isNaN(x = +this._x.call(null, d = data[i])) || isNaN(y = +this._y.call(null, d))) continue;
    xz[i] = x;
    yz[i] = y;
    if (x < x0) x0 = x;
    if (x > x1) x1 = x;
    if (y < y0) y0 = y;
    if (y > y1) y1 = y;
  }

  if (x0 > x1 || y0 > y1) return this;
  this.cover(x0, y0).cover(x1, y1);

  for (i = 0; i < n; ++i) {
    add(this, xz[i], yz[i], data[i]);
  }

  return this;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hZGQuanMiXSwibmFtZXMiOlsiZCIsIngiLCJfeCIsImNhbGwiLCJ5IiwiX3kiLCJhZGQiLCJjb3ZlciIsInRyZWUiLCJpc05hTiIsInBhcmVudCIsIm5vZGUiLCJfcm9vdCIsImxlYWYiLCJkYXRhIiwieDAiLCJfeDAiLCJ5MCIsIl95MCIsIngxIiwiX3gxIiwieTEiLCJfeTEiLCJ4bSIsInltIiwieHAiLCJ5cCIsInJpZ2h0IiwiYm90dG9tIiwiaSIsImoiLCJsZW5ndGgiLCJuZXh0IiwiQXJyYXkiLCJhZGRBbGwiLCJuIiwieHoiLCJ5eiIsIkluZmluaXR5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFlLGtCQUFTQSxDQUFULEVBQVk7QUFDekIsTUFBSUMsQ0FBQyxHQUFHLENBQUMsS0FBS0MsRUFBTCxDQUFRQyxJQUFSLENBQWEsSUFBYixFQUFtQkgsQ0FBbkIsQ0FBVDtBQUFBLE1BQ0lJLENBQUMsR0FBRyxDQUFDLEtBQUtDLEVBQUwsQ0FBUUYsSUFBUixDQUFhLElBQWIsRUFBbUJILENBQW5CLENBRFQ7QUFFQSxTQUFPTSxHQUFHLENBQUMsS0FBS0MsS0FBTCxDQUFXTixDQUFYLEVBQWNHLENBQWQsQ0FBRCxFQUFtQkgsQ0FBbkIsRUFBc0JHLENBQXRCLEVBQXlCSixDQUF6QixDQUFWO0FBQ0Q7O0FBRUQsU0FBU00sR0FBVCxDQUFhRSxJQUFiLEVBQW1CUCxDQUFuQixFQUFzQkcsQ0FBdEIsRUFBeUJKLENBQXpCLEVBQTRCO0FBQzFCLE1BQUlTLEtBQUssQ0FBQ1IsQ0FBRCxDQUFMLElBQVlRLEtBQUssQ0FBQ0wsQ0FBRCxDQUFyQixFQUEwQixPQUFPSSxJQUFQO0FBRTFCLE1BQUlFLE1BQUo7QUFBQSxNQUNJQyxJQUFJLEdBQUdILElBQUksQ0FBQ0ksS0FEaEI7QUFBQSxNQUVJQyxJQUFJLEdBQUc7QUFBQ0MsSUFBQUEsSUFBSSxFQUFFZDtBQUFQLEdBRlg7QUFBQSxNQUdJZSxFQUFFLEdBQUdQLElBQUksQ0FBQ1EsR0FIZDtBQUFBLE1BSUlDLEVBQUUsR0FBR1QsSUFBSSxDQUFDVSxHQUpkO0FBQUEsTUFLSUMsRUFBRSxHQUFHWCxJQUFJLENBQUNZLEdBTGQ7QUFBQSxNQU1JQyxFQUFFLEdBQUdiLElBQUksQ0FBQ2MsR0FOZDtBQUFBLE1BT0lDLEVBUEo7QUFBQSxNQVFJQyxFQVJKO0FBQUEsTUFTSUMsRUFUSjtBQUFBLE1BVUlDLEVBVko7QUFBQSxNQVdJQyxLQVhKO0FBQUEsTUFZSUMsTUFaSjtBQUFBLE1BYUlDLENBYko7QUFBQSxNQWNJQyxDQWRKO0FBaUJBLE1BQUksQ0FBQ25CLElBQUwsRUFBVyxPQUFPSCxJQUFJLENBQUNJLEtBQUwsR0FBYUMsSUFBYixFQUFtQkwsSUFBMUI7O0FBR1gsU0FBT0csSUFBSSxDQUFDb0IsTUFBWixFQUFvQjtBQUNsQixRQUFJSixLQUFLLEdBQUcxQixDQUFDLEtBQUtzQixFQUFFLEdBQUcsQ0FBQ1IsRUFBRSxHQUFHSSxFQUFOLElBQVksQ0FBdEIsQ0FBYixFQUF1Q0osRUFBRSxHQUFHUSxFQUFMLENBQXZDLEtBQXFESixFQUFFLEdBQUdJLEVBQUw7QUFDckQsUUFBSUssTUFBTSxHQUFHeEIsQ0FBQyxLQUFLb0IsRUFBRSxHQUFHLENBQUNQLEVBQUUsR0FBR0ksRUFBTixJQUFZLENBQXRCLENBQWQsRUFBd0NKLEVBQUUsR0FBR08sRUFBTCxDQUF4QyxLQUFzREgsRUFBRSxHQUFHRyxFQUFMO0FBQ3RELFFBQUlkLE1BQU0sR0FBR0MsSUFBVCxFQUFlLEVBQUVBLElBQUksR0FBR0EsSUFBSSxDQUFDa0IsQ0FBQyxHQUFHRCxNQUFNLElBQUksQ0FBVixHQUFjRCxLQUFuQixDQUFiLENBQW5CLEVBQTRELE9BQU9qQixNQUFNLENBQUNtQixDQUFELENBQU4sR0FBWWhCLElBQVosRUFBa0JMLElBQXpCO0FBQzdEOztBQUdEaUIsRUFBQUEsRUFBRSxHQUFHLENBQUNqQixJQUFJLENBQUNOLEVBQUwsQ0FBUUMsSUFBUixDQUFhLElBQWIsRUFBbUJRLElBQUksQ0FBQ0csSUFBeEIsQ0FBTjtBQUNBWSxFQUFBQSxFQUFFLEdBQUcsQ0FBQ2xCLElBQUksQ0FBQ0gsRUFBTCxDQUFRRixJQUFSLENBQWEsSUFBYixFQUFtQlEsSUFBSSxDQUFDRyxJQUF4QixDQUFOO0FBQ0EsTUFBSWIsQ0FBQyxLQUFLd0IsRUFBTixJQUFZckIsQ0FBQyxLQUFLc0IsRUFBdEIsRUFBMEIsT0FBT2IsSUFBSSxDQUFDbUIsSUFBTCxHQUFZckIsSUFBWixFQUFrQkQsTUFBTSxHQUFHQSxNQUFNLENBQUNtQixDQUFELENBQU4sR0FBWWhCLElBQWYsR0FBc0JMLElBQUksQ0FBQ0ksS0FBTCxHQUFhQyxJQUEzRCxFQUFpRUwsSUFBeEU7O0FBRzFCLEtBQUc7QUFDREUsSUFBQUEsTUFBTSxHQUFHQSxNQUFNLEdBQUdBLE1BQU0sQ0FBQ21CLENBQUQsQ0FBTixHQUFZLElBQUlJLEtBQUosQ0FBVSxDQUFWLENBQWYsR0FBOEJ6QixJQUFJLENBQUNJLEtBQUwsR0FBYSxJQUFJcUIsS0FBSixDQUFVLENBQVYsQ0FBMUQ7QUFDQSxRQUFJTixLQUFLLEdBQUcxQixDQUFDLEtBQUtzQixFQUFFLEdBQUcsQ0FBQ1IsRUFBRSxHQUFHSSxFQUFOLElBQVksQ0FBdEIsQ0FBYixFQUF1Q0osRUFBRSxHQUFHUSxFQUFMLENBQXZDLEtBQXFESixFQUFFLEdBQUdJLEVBQUw7QUFDckQsUUFBSUssTUFBTSxHQUFHeEIsQ0FBQyxLQUFLb0IsRUFBRSxHQUFHLENBQUNQLEVBQUUsR0FBR0ksRUFBTixJQUFZLENBQXRCLENBQWQsRUFBd0NKLEVBQUUsR0FBR08sRUFBTCxDQUF4QyxLQUFzREgsRUFBRSxHQUFHRyxFQUFMO0FBQ3ZELEdBSkQsUUFJUyxDQUFDSyxDQUFDLEdBQUdELE1BQU0sSUFBSSxDQUFWLEdBQWNELEtBQW5CLE9BQStCRyxDQUFDLEdBQUcsQ0FBQ0osRUFBRSxJQUFJRixFQUFQLEtBQWMsQ0FBZCxHQUFtQkMsRUFBRSxJQUFJRixFQUE1RCxDQUpUOztBQUtBLFNBQU9iLE1BQU0sQ0FBQ29CLENBQUQsQ0FBTixHQUFZbkIsSUFBWixFQUFrQkQsTUFBTSxDQUFDbUIsQ0FBRCxDQUFOLEdBQVloQixJQUE5QixFQUFvQ0wsSUFBM0M7QUFDRDs7QUFFTSxTQUFTMEIsTUFBVCxDQUFnQnBCLElBQWhCLEVBQXNCO0FBQzNCLE1BQUlkLENBQUo7QUFBQSxNQUFPNkIsQ0FBUDtBQUFBLE1BQVVNLENBQUMsR0FBR3JCLElBQUksQ0FBQ2lCLE1BQW5CO0FBQUEsTUFDSTlCLENBREo7QUFBQSxNQUVJRyxDQUZKO0FBQUEsTUFHSWdDLEVBQUUsR0FBRyxJQUFJSCxLQUFKLENBQVVFLENBQVYsQ0FIVDtBQUFBLE1BSUlFLEVBQUUsR0FBRyxJQUFJSixLQUFKLENBQVVFLENBQVYsQ0FKVDtBQUFBLE1BS0lwQixFQUFFLEdBQUd1QixRQUxUO0FBQUEsTUFNSXJCLEVBQUUsR0FBR3FCLFFBTlQ7QUFBQSxNQU9JbkIsRUFBRSxHQUFHLENBQUNtQixRQVBWO0FBQUEsTUFRSWpCLEVBQUUsR0FBRyxDQUFDaUIsUUFSVjs7QUFXQSxPQUFLVCxDQUFDLEdBQUcsQ0FBVCxFQUFZQSxDQUFDLEdBQUdNLENBQWhCLEVBQW1CLEVBQUVOLENBQXJCLEVBQXdCO0FBQ3RCLFFBQUlwQixLQUFLLENBQUNSLENBQUMsR0FBRyxDQUFDLEtBQUtDLEVBQUwsQ0FBUUMsSUFBUixDQUFhLElBQWIsRUFBbUJILENBQUMsR0FBR2MsSUFBSSxDQUFDZSxDQUFELENBQTNCLENBQU4sQ0FBTCxJQUErQ3BCLEtBQUssQ0FBQ0wsQ0FBQyxHQUFHLENBQUMsS0FBS0MsRUFBTCxDQUFRRixJQUFSLENBQWEsSUFBYixFQUFtQkgsQ0FBbkIsQ0FBTixDQUF4RCxFQUFzRjtBQUN0Rm9DLElBQUFBLEVBQUUsQ0FBQ1AsQ0FBRCxDQUFGLEdBQVE1QixDQUFSO0FBQ0FvQyxJQUFBQSxFQUFFLENBQUNSLENBQUQsQ0FBRixHQUFRekIsQ0FBUjtBQUNBLFFBQUlILENBQUMsR0FBR2MsRUFBUixFQUFZQSxFQUFFLEdBQUdkLENBQUw7QUFDWixRQUFJQSxDQUFDLEdBQUdrQixFQUFSLEVBQVlBLEVBQUUsR0FBR2xCLENBQUw7QUFDWixRQUFJRyxDQUFDLEdBQUdhLEVBQVIsRUFBWUEsRUFBRSxHQUFHYixDQUFMO0FBQ1osUUFBSUEsQ0FBQyxHQUFHaUIsRUFBUixFQUFZQSxFQUFFLEdBQUdqQixDQUFMO0FBQ2I7O0FBR0QsTUFBSVcsRUFBRSxHQUFHSSxFQUFMLElBQVdGLEVBQUUsR0FBR0ksRUFBcEIsRUFBd0IsT0FBTyxJQUFQO0FBR3hCLE9BQUtkLEtBQUwsQ0FBV1EsRUFBWCxFQUFlRSxFQUFmLEVBQW1CVixLQUFuQixDQUF5QlksRUFBekIsRUFBNkJFLEVBQTdCOztBQUdBLE9BQUtRLENBQUMsR0FBRyxDQUFULEVBQVlBLENBQUMsR0FBR00sQ0FBaEIsRUFBbUIsRUFBRU4sQ0FBckIsRUFBd0I7QUFDdEJ2QixJQUFBQSxHQUFHLENBQUMsSUFBRCxFQUFPOEIsRUFBRSxDQUFDUCxDQUFELENBQVQsRUFBY1EsRUFBRSxDQUFDUixDQUFELENBQWhCLEVBQXFCZixJQUFJLENBQUNlLENBQUQsQ0FBekIsQ0FBSDtBQUNEOztBQUVELFNBQU8sSUFBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24oZCkge1xuICB2YXIgeCA9ICt0aGlzLl94LmNhbGwobnVsbCwgZCksXG4gICAgICB5ID0gK3RoaXMuX3kuY2FsbChudWxsLCBkKTtcbiAgcmV0dXJuIGFkZCh0aGlzLmNvdmVyKHgsIHkpLCB4LCB5LCBkKTtcbn1cblxuZnVuY3Rpb24gYWRkKHRyZWUsIHgsIHksIGQpIHtcbiAgaWYgKGlzTmFOKHgpIHx8IGlzTmFOKHkpKSByZXR1cm4gdHJlZTsgLy8gaWdub3JlIGludmFsaWQgcG9pbnRzXG5cbiAgdmFyIHBhcmVudCxcbiAgICAgIG5vZGUgPSB0cmVlLl9yb290LFxuICAgICAgbGVhZiA9IHtkYXRhOiBkfSxcbiAgICAgIHgwID0gdHJlZS5feDAsXG4gICAgICB5MCA9IHRyZWUuX3kwLFxuICAgICAgeDEgPSB0cmVlLl94MSxcbiAgICAgIHkxID0gdHJlZS5feTEsXG4gICAgICB4bSxcbiAgICAgIHltLFxuICAgICAgeHAsXG4gICAgICB5cCxcbiAgICAgIHJpZ2h0LFxuICAgICAgYm90dG9tLFxuICAgICAgaSxcbiAgICAgIGo7XG5cbiAgLy8gSWYgdGhlIHRyZWUgaXMgZW1wdHksIGluaXRpYWxpemUgdGhlIHJvb3QgYXMgYSBsZWFmLlxuICBpZiAoIW5vZGUpIHJldHVybiB0cmVlLl9yb290ID0gbGVhZiwgdHJlZTtcblxuICAvLyBGaW5kIHRoZSBleGlzdGluZyBsZWFmIGZvciB0aGUgbmV3IHBvaW50LCBvciBhZGQgaXQuXG4gIHdoaWxlIChub2RlLmxlbmd0aCkge1xuICAgIGlmIChyaWdodCA9IHggPj0gKHhtID0gKHgwICsgeDEpIC8gMikpIHgwID0geG07IGVsc2UgeDEgPSB4bTtcbiAgICBpZiAoYm90dG9tID0geSA+PSAoeW0gPSAoeTAgKyB5MSkgLyAyKSkgeTAgPSB5bTsgZWxzZSB5MSA9IHltO1xuICAgIGlmIChwYXJlbnQgPSBub2RlLCAhKG5vZGUgPSBub2RlW2kgPSBib3R0b20gPDwgMSB8IHJpZ2h0XSkpIHJldHVybiBwYXJlbnRbaV0gPSBsZWFmLCB0cmVlO1xuICB9XG5cbiAgLy8gSXMgdGhlIG5ldyBwb2ludCBpcyBleGFjdGx5IGNvaW5jaWRlbnQgd2l0aCB0aGUgZXhpc3RpbmcgcG9pbnQ/XG4gIHhwID0gK3RyZWUuX3guY2FsbChudWxsLCBub2RlLmRhdGEpO1xuICB5cCA9ICt0cmVlLl95LmNhbGwobnVsbCwgbm9kZS5kYXRhKTtcbiAgaWYgKHggPT09IHhwICYmIHkgPT09IHlwKSByZXR1cm4gbGVhZi5uZXh0ID0gbm9kZSwgcGFyZW50ID8gcGFyZW50W2ldID0gbGVhZiA6IHRyZWUuX3Jvb3QgPSBsZWFmLCB0cmVlO1xuXG4gIC8vIE90aGVyd2lzZSwgc3BsaXQgdGhlIGxlYWYgbm9kZSB1bnRpbCB0aGUgb2xkIGFuZCBuZXcgcG9pbnQgYXJlIHNlcGFyYXRlZC5cbiAgZG8ge1xuICAgIHBhcmVudCA9IHBhcmVudCA/IHBhcmVudFtpXSA9IG5ldyBBcnJheSg0KSA6IHRyZWUuX3Jvb3QgPSBuZXcgQXJyYXkoNCk7XG4gICAgaWYgKHJpZ2h0ID0geCA+PSAoeG0gPSAoeDAgKyB4MSkgLyAyKSkgeDAgPSB4bTsgZWxzZSB4MSA9IHhtO1xuICAgIGlmIChib3R0b20gPSB5ID49ICh5bSA9ICh5MCArIHkxKSAvIDIpKSB5MCA9IHltOyBlbHNlIHkxID0geW07XG4gIH0gd2hpbGUgKChpID0gYm90dG9tIDw8IDEgfCByaWdodCkgPT09IChqID0gKHlwID49IHltKSA8PCAxIHwgKHhwID49IHhtKSkpO1xuICByZXR1cm4gcGFyZW50W2pdID0gbm9kZSwgcGFyZW50W2ldID0gbGVhZiwgdHJlZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFkZEFsbChkYXRhKSB7XG4gIHZhciBkLCBpLCBuID0gZGF0YS5sZW5ndGgsXG4gICAgICB4LFxuICAgICAgeSxcbiAgICAgIHh6ID0gbmV3IEFycmF5KG4pLFxuICAgICAgeXogPSBuZXcgQXJyYXkobiksXG4gICAgICB4MCA9IEluZmluaXR5LFxuICAgICAgeTAgPSBJbmZpbml0eSxcbiAgICAgIHgxID0gLUluZmluaXR5LFxuICAgICAgeTEgPSAtSW5maW5pdHk7XG5cbiAgLy8gQ29tcHV0ZSB0aGUgcG9pbnRzIGFuZCB0aGVpciBleHRlbnQuXG4gIGZvciAoaSA9IDA7IGkgPCBuOyArK2kpIHtcbiAgICBpZiAoaXNOYU4oeCA9ICt0aGlzLl94LmNhbGwobnVsbCwgZCA9IGRhdGFbaV0pKSB8fCBpc05hTih5ID0gK3RoaXMuX3kuY2FsbChudWxsLCBkKSkpIGNvbnRpbnVlO1xuICAgIHh6W2ldID0geDtcbiAgICB5eltpXSA9IHk7XG4gICAgaWYgKHggPCB4MCkgeDAgPSB4O1xuICAgIGlmICh4ID4geDEpIHgxID0geDtcbiAgICBpZiAoeSA8IHkwKSB5MCA9IHk7XG4gICAgaWYgKHkgPiB5MSkgeTEgPSB5O1xuICB9XG5cbiAgLy8gSWYgdGhlcmUgd2VyZSBubyAodmFsaWQpIHBvaW50cywgYWJvcnQuXG4gIGlmICh4MCA+IHgxIHx8IHkwID4geTEpIHJldHVybiB0aGlzO1xuXG4gIC8vIEV4cGFuZCB0aGUgdHJlZSB0byBjb3ZlciB0aGUgbmV3IHBvaW50cy5cbiAgdGhpcy5jb3Zlcih4MCwgeTApLmNvdmVyKHgxLCB5MSk7XG5cbiAgLy8gQWRkIHRoZSBuZXcgcG9pbnRzLlxuICBmb3IgKGkgPSAwOyBpIDwgbjsgKytpKSB7XG4gICAgYWRkKHRoaXMsIHh6W2ldLCB5eltpXSwgZGF0YVtpXSk7XG4gIH1cblxuICByZXR1cm4gdGhpcztcbn1cbiJdfQ==